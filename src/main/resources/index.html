<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Predina GEO Marker</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #predina_map {
        height: 500px;
		width: 600px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

</head>
<body>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyBbeoLp1wm-tZdVX6t2kF1l0SkjX8iVNcU"></script>
<script src="http://acme.com/javascript/acme.namespace.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.utils.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.maps3.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.maps3.maptypes.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.maps3.zoom5.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.maps3.typecontrol.jsm" type="text/javascript"></script>
<script src="http://acme.com/javascript/acme.overlaymessage.jsm" type="text/javascript"></script>


<table border="0" width="100%">
    <tr>
        <td align="center"><br/></td>
    </tr>
    <tr>
        <td align="center"><br/></td>
    </tr>
    <tr>
        <td align="center"><div id="predina_map"/></td>
    </tr>
</table>
<script type="text/javascript">

var om = null;
var map = null;
var infowindow = null;
var springs;



var map;
var infoWindow;
var bounds;
var xhr;
var markers;
var markerCluster;

        /*
         * marker creater function (acts as a closure for html parameter)
         */
        function createMarker(options, html) {
            var marker = new google.maps.Marker(options);
            //bounds.extend(options.position);
            if (html) {
                google.maps.event.addListener(marker, "click", function() {
                    infoWindow.setContent(html);
                    infoWindow.open(options.map, this);
                    map.setZoom(map.getZoom() + 1);
                    map.setCenter(marker.getPosition());
                });
            }
            return marker;
        }

		/*
		 * getColor
		 */
		function getColor(c) {
           if (c == 'G')
              return "green";
           else if (c == 'Y')
              return "yellow";
           else if (c == 'O')
              return "orange";
           else if (c == 'R')
              return "red";
           else
              return "#8b0000";
        }

		function callback(topLeftLat, topLeftLng, botRghtLat, botRghtLnt, zoom){
		   var url = 'http://localhost:7001/find/'+topLeftLat+'/'+topLeftLng+'/'+botRghtLat+'/'+botRghtLnt;
           xhr.open("GET", url, true);
		   xhr.onreadystatechange = function(){
		      if (xhr.readyState != 4) {
                 return;
              }
			  var obj = JSON.parse(xhr.responseText);
              var len = obj.s;
			  var places = obj.d;
              markers = [];
              for (var i = 0; i < len; i++) {
			     var point = places[i];
				 var cMarker = createMarker({
				       position: new google.maps.LatLng(point[0], point[1]),
					   map: map,
					   icon: {
                          path: google.maps.SymbolPath.CIRCLE,
                          fillColor: getColor(point[2]),
                          fillOpacity: .4,
                          scale: 1,
                          strokeColor: getColor(point[2]),
                          strokeWeight: 1
                       }},'');
				 markers.push(cMarker);
              }
              map.fitBounds(bounds);
		   };
		   xhr.send();
		}



		function refreshMap() {
			 var b = map.getBounds();
			 var zoom = map.getZoom();

			if((zoom > 4 && zoom < 15)){
		       if(b && b.getNorthEast()){
			       callback(b.getNorthEast().lat(), b.getSouthWest().lng(), b.getSouthWest().lat(), b.getNorthEast().lng(), zoom);
			   }else{
			      callback(60.9, -9.0, 49.9, 10.0, zoom);
			   }
			}
		}

		function markerClusterClick(){
		    return;
		}

/*
 * use google maps api built-in mechanism to attach dom events
 */
google.maps.event.addDomListener(window, "load", function() {

        xhr = new XMLHttpRequest();
        markers = [];

        /*
         * create map
         */
        map = new google.maps.Map(document.getElementById("predina_map"), {
		    zoom: 6,
            center: new google.maps.LatLng(55.4,0.5),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });



        /*
         * create infowindow (which will be used by markers)
         */
        infoWindow = new google.maps.InfoWindow();
        /*
         * create bounds (which will be used auto zoom map)
         */
        bounds = new google.maps.LatLngBounds();

		refreshMap();

		map.addListener('click', refreshMap);

        //callback(60.9, -9.0, 49.9, 10.0);
});

</script>
</body>
</html>