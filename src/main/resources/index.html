<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Predina GEO Marker</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #predina_map {
        height: 500px;
		width: 600px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
</style>
</head>
<body>
<br/><br/>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyBbeoLp1wm-tZdVX6t2kF1l0SkjX8iVNcU"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<table border="0" width="100%">
    <tr>
        <td align="center"><br/></td>
    </tr>
    <tr>
        <td align="center"><br/></td>
    </tr>
    <tr>
        <td align="center"><div id="predina_map"/></td>
    </tr>
</table>

<script type="text/javascript">

/*
 * use google maps api built-in mechanism to attach dom events
 * https://github.com/cyrilcherian/million-points-on-map
 */
google.maps.event.addDomListener(window, "load", function() {



        /*
         * create map
         */
        var map = new google.maps.Map(document.getElementById("predina_map"), {
            mapTypeId: google.maps.MapTypeId.ROADMAP,
        });

        /*
         * create infowindow (which will be used by markers)
         */
        var infoWindow = new google.maps.InfoWindow();
        /*
         * create bounds (which will be used auto zoom map)
         */
        var bounds = new google.maps.LatLngBounds();

		/*
		 * getColor
		 */
		function getColor(c) {
           if (c == 'G')
              return "green";
           else if (c == 'Y')
              return "yellow";
           else if (c == 'O')
              return "orange";
           else if (c == 'R')
              return "red";
           else
              return "#8b0000";
        }

        /*
         * marker creater function (acts as a closure for html parameter)
         */
        function createMarker(options, html) {
            var marker = new google.maps.Marker(options);
            bounds.extend(options.position);
            if (html) {
                google.maps.event.addListener(marker, "click", function() {
                    infoWindow.setContent(html);
                    infoWindow.open(options.map, this);
                    map.setZoom(map.getZoom() + 1)
                    map.setCenter(marker.getPosition());
                });
            }
            return marker;
        }

		function windowsActiveXObject(){
		    try {
                return new ActiveXObject("Msxml2.XMLHTTP")
            } catch (e) {
                try {
                    return new ActiveXObject("Microsoft.XMLHTTP")
                } catch (e) {}

            }
		}

		var xhr = (window.XMLHttpRequest) ? new XMLHttpRequest() :  windowsActiveXObject();
		var markers = [];
		var markerCluster = [];

		function callback(p){
		   //var url = 'http://localhost:8080/find/61.215861140782756/-16.060280250000005/48.73237566003298/10.306907249999995';
		   var url = 'http://localhost:8080/page/'+p+'/75000';
           xhr.open("GET", url, true);
		   xhr.onreadystatechange = function(){
		      if (xhr.readyState != 4) {
                 return;
              }
			  var obj = JSON.parse(xhr.responseText);
			  var max = obj.m;
			  var places = obj.d;
              for (var i = 0, len =  places.length; i < len; i++) {
			     var point = places[i];
				 var cMarker = createMarker({
				       position: new google.maps.LatLng(point[0], point[1]),
					   map: map,
					   icon: {
                          path: google.maps.SymbolPath.CIRCLE,
                          fillColor: getColor(point[2]),
                          fillOpacity: .4,
                          scale: 1,
                          strokeColor: getColor(point[2]),
                          strokeWeight: 1
                       }},'');
				  markers.push(cMarker);
              }
			  markerCluster = new MarkerClusterer(map, markers,
                                         {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
              map.fitBounds(bounds);
              if(p < max/2){
                  callback(p+1);
              }else{
			     return;
			  }
		   };
		   xhr.send();
		}
        callback(1);

});
</script>
</body>
</html>